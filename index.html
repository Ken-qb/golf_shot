<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ゴルフ・ショット記録（1ファイル版）</title>
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 / ReactDOM 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel (JSXトランスパイル用) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAQAAACq6DbKAAAAJUlEQVR42u3MMQEAAAgDIN8/9K2hQwQp4qkAAAAAAAAAAAAAAAAA4G0B2lpn8cG4yQAAAABJRU5ErkJggg==" />
  <style>
    html,body { background: #f5f5f5; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    const CLUBS = [
      { key: "D", label: "D(ドライバー)" },
      { key: "3W", label: "3W" },
      { key: "5W", label: "5W" },
      { key: "UT", label: "UT" },
      { key: "5i", label: "5i" },
      { key: "6i", label: "6i" },
      { key: "7i", label: "7i" },
      { key: "8i", label: "8i" },
      { key: "9i", label: "9i" },
      { key: "PW", label: "PW" },
      { key: "SW", label: "SW" },
      { key: "P", label: "P(パター)" },
    ];

    const TAGS = [
      { key: "NICE", label: "ナイショ" },
      { key: "TOP", label: "トップ" },
      { key: "DUFF", label: "ダフリ" },
      { key: "CHORO", label: "チョロ" },
      { key: "SHORT", label: "ショート" },
      { key: "LONG", label: "オーバー" },
      { key: "RIGHT", label: "右" },
      { key: "LEFT", label: "左" },
      { key: "SLICE", label: "スライス" },
      { key: "HOOK", label: "フック" },
      { key: "OB_R", label: "OB右" },
      { key: "OB_L", label: "OB左" },
      { key: "BUNKER", label: "バンカー" },
      { key: "WATER", label: "池" },
      { key: "FW", label: "FWキープ" },
      { key: "GREEN", label: "オン" },
    ];

    const STORAGE_KEY = "golf-shots-v1";

    function useLocalShots() {
      const [shots, setShots] = useState([]);

      useEffect(() => {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) setShots(JSON.parse(raw));
        } catch {}
      }, []);

      useEffect(() => {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(shots));
        } catch {}
      }, [shots]);

      return { shots, setShots };
    }

    function uuid() {
      return Math.random().toString(36).slice(2) + Date.now().toString(36);
    }

    function toCSV(shots) {
      const header = [
        "date","course","hole","shot","club","tags","comment","createdAt",
      ];
      const lines = shots.map((s) => [
        s.date,
        s.course,
        s.hole,
        s.shot,
        s.club,
        (s.tags||[]).join("|"),
        (s.comment||"").replaceAll("\n"," ").replaceAll(","," "),
        s.createdAt,
      ].map(v => `"${String(v ?? '').replaceAll('"','""')}"`).join(","));
      return [header.join(","), ...lines].join("\n");
    }

    function GolfShotLogger() {
      const { shots, setShots } = useLocalShots();

      const [course, setCourse] = useState("近江カントリー");
      const [date, setDate] = useState(() => new Date().toISOString().slice(0,10));
      const [hole, setHole] = useState(1);
      const [shotNo, setShotNo] = useState(1);
      const [club, setClub] = useState("");
      const [tags, setTags] = useState([]);
      const [comment, setComment] = useState("");
      const [toast, setToast] = useState(null);

      useEffect(() => {
        const max = shots
          .filter((s) => s.date === date && s.course === course && s.hole === hole)
          .reduce((m, s) => Math.max(m, s.shot), 0);
        setShotNo(max + 1 || 1);
      }, [hole, course, date]);

      function toggleTag(k) {
        setTags((prev) => prev.includes(k) ? prev.filter((t)=>t!==k) : [...prev, k]);
      }

      function resetForm(nextShot = true) {
        setClub("");
        setTags([]);
        setComment("");
        setShotNo((n) => nextShot ? n + 1 : n);
      }

      function saveShot() {
        if (!club && tags.length === 0 && !comment.trim()) {
          setToast("クラブかタグ、またはコメントのいずれかは入力してください");
          return;
        }
        const record = {
          id: uuid(),
          date,
          course: course.trim() || "コース未設定",
          hole,
          shot: shotNo,
          club: club || "",
          tags,
          comment: comment.trim(),
          createdAt: new Date().toISOString(),
        };
        setShots((prev)=>[...prev, record]);
        setToast(`${hole}H ${shotNo}打目を保存しました`);
        resetForm(true);
      }

      function nextHole() {
        setHole((h)=>h<18? h+1 : 18);
        setShotNo(1);
        setTags([]);
        setClub("");
        setComment("");
      }

      function prevHole() {
        setHole((h)=>h>1? h-1 : 1);
        setShotNo(1);
        setTags([]);
        setClub("");
        setComment("");
      }

      function undoLast() {
        if (!shots.length) return;
        setShots((prev)=>prev.slice(0,-1));
        setToast("最後のショットを削除しました");
      }

      async function copyCSV() {
        try {
          const csv = toCSV(shots);
          await navigator.clipboard.writeText(csv);
          setToast("CSVをクリップボードにコピーしました");
        } catch (e) {
          setToast("コピーに失敗しました");
        }
      }

      function downloadCSV() {
        const csv = toCSV(shots);
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        const base = `${date}_${course||'course'}`.replace(/[^a-zA-Z0-9_\-一-龯ぁ-んァ-ヶ]/g, "");
        a.download = `${base}_shots.csv`;
        a.click();
        URL.revokeObjectURL(url);
      }

      const todayShots = useMemo(
        () => shots.filter((s)=>s.date===date && s.course===course),
        [shots, date, course]
      );

      const holeShots = useMemo(
        () => todayShots.filter((s)=>s.hole===hole).sort((a,b)=>a.shot-b.shot),
        [todayShots, hole]
      );

      return (
        <div className="min-h-screen bg-neutral-100 text-neutral-900 p-4 sm:p-6">
          <div className="max-w-3xl mx-auto">
            <header className="flex items-center justify-between gap-3 mb-4">
              <h1 className="text-2xl font-bold">ゴルフ・ショット記録</h1>
              <div className="flex gap-2">
                <button onClick={copyCSV} className="px-3 py-2 rounded-xl bg-white shadow text-sm">CSVコピー</button>
                <button onClick={downloadCSV} className="px-3 py-2 rounded-xl bg-white shadow text-sm">CSV保存</button>
              </div>
            </header>

            <div className="grid grid-cols-1 gap-3 mb-4">
              <label className="bg-white rounded-2xl shadow p-3 flex items-center gap-3">
                <span className="text-sm w-16">日付</span>
                <input type="date" value={date} onChange={(e)=>setDate(e.target.value)} className="flex-1 bg-neutral-50 rounded-xl px-3 py-2" />
              </label>
              <label className="bg-white rounded-2xl shadow p-3 flex items-center gap-3">
                <span className="text-sm w-16">コース</span>
                <input type="text" value={course} onChange={(e)=>setCourse(e.target.value)} placeholder="例: 近江カントリー" className="flex-1 bg-neutral-50 rounded-xl px-3 py-2" />
              </label>
            </div>

            <section className="bg-white rounded-2xl shadow p-3 mb-4">
              <div className="flex items-center justify-between mb-3">
                <div className="flex items-center gap-2">
                  <button onClick={prevHole} className="px-3 py-2 rounded-xl bg-neutral-100">◀</button>
                  <div className="text-lg font-semibold">{hole}H</div>
                  <button onClick={nextHole} className="px-3 py-2 rounded-xl bg-neutral-100">▶</button>
                </div>
                <div className="text-sm opacity-80">このホールの記録: {holeShots.length}件</div>
              </div>

              <div className="grid grid-cols-2 sm:grid-cols-3 gap-2 mb-3">
                {Array.from({ length: 18 }, (_, i) => i + 1).map((h) => (
                  <button
                    key={h}
                    onClick={() => setHole(h)}
                    className={`px-2 py-2 rounded-xl border text-sm ${hole===h? 'bg-neutral-900 text-white':'bg-neutral-50'}`}
                  >
                    {h}H
                  </button>
                ))}
              </div>

              <div className="flex items-center gap-3 mb-3">
                <div className="text-sm w-24">ショット</div>
                <div className="px-3 py-2 rounded-xl bg-neutral-100 w-20 text-center font-semibold">{shotNo}打目</div>
                <button onClick={() => setShotNo((n)=>Math.max(1, n-1))} className="px-3 py-2 rounded-xl bg-neutral-100">-</button>
                <button onClick={() => setShotNo((n)=>n+1)} className="px-3 py-2 rounded-xl bg-neutral-100">+</button>
              </div>

              <div className="mb-3">
                <div className="text-sm mb-2">クラブ</div>
                <div className="grid grid-cols-3 sm:grid-cols-6 gap-2">
                  {CLUBS.map((c) => (
                    <button
                      key={c.key}
                      onClick={() => setClub(c.key)}
                      className={`px-3 py-2 rounded-xl border text-sm ${club===c.key? 'bg-neutral-900 text-white':'bg-neutral-50'}`}
                    >
                      {c.label}
                    </button>
                  ))}
                </div>
              </div>

              <div className="mb-3">
                <div className="text-sm mb-2">結果タグ（複数可）</div>
                <div className="grid grid-cols-3 sm:grid-cols-6 gap-2">
                  {TAGS.map((t) => (
                    <button
                      key={t.key}
                      onClick={() => toggleTag(t.key)}
                      className={`px-3 py-2 rounded-xl border text-sm ${tags.includes(t.key)? 'bg-neutral-900 text-white':'bg-neutral-50'}`}
                    >
                      {t.label}
                    </button>
                  ))}
                </div>
              </div>

              <label className="block mb-3">
                <div className="text-sm mb-2">コメント（任意）</div>
                <textarea
                  value={comment}
                  onChange={(e)=>setComment(e.target.value)}
                  placeholder="例：振り遅れ、やや右。バンカー手前にショート"
                  className="w-full bg-neutral-50 rounded-xl px-3 py-2 min-h-[64px]"
                />
              </label>

              <div className="flex gap-2">
                <button onClick={saveShot} className="flex-1 px-4 py-3 rounded-2xl bg-neutral-900 text-white font-semibold">ショットを保存</button>
                <button onClick={resetForm} className="px-4 py-3 rounded-2xl bg-neutral-200">次のショット</button>
                <button onClick={nextHole} className="px-4 py-3 rounded-2xl bg-neutral-200">次のホール</button>
              </div>
            </section>

            <section className="bg-white rounded-2xl shadow p-3 mb-28">
              <div className="flex items-center justify-between mb-2">
                <h2 className="font-semibold">本日の記録一覧</h2>
                <button onClick={undoLast} className="px-3 py-2 rounded-xl bg-neutral-100 text-sm">Undo（最後を削除）</button>
              </div>
              <div className="text-sm opacity-80 mb-2">{todayShots.length}件</div>
              <div className="divide-y">
                {todayShots
                  .slice()
                  .sort((a,b)=>a.hole - b.hole || a.shot - b.shot)
                  .map((s) => (
                    <div key={s.id} className="py-2 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                      <div className="text-sm">
                        <span className="inline-block w-10 font-semibold">{s.hole}H</span>
                        <span className="inline-block w-12">{s.shot}打目</span>
                        <span className="inline-block w-20 opacity-80">{s.club}</span>
                        <span className="inline-block opacity-80">{(s.tags||[]).map(k => (TAGS.find(t=>t.key===k)||{}).label || k).join("・")}</span>
                        {s.comment && (
                          <span className="inline-block opacity-80 ml-2">｜{s.comment}</span>
                        )}
                      </div>
                      <div className="text-xs opacity-60">{new Date(s.createdAt).toLocaleTimeString()}</div>
                    </div>
                  ))}
              </div>
            </section>

            {toast && (
              <div className="fixed bottom-4 left-0 right-0 mx-auto max-w-md bg-black text-white text-sm px-4 py-3 rounded-2xl shadow-lg">
                {toast}
                <button onClick={() => setToast(null)} className="float-right opacity-70">✕</button>
              </div>
            )}

            <footer className="fixed bottom-0 left-0 right-0 bg-white border-t p-3">
              <div className="max-w-3xl mx-auto text-center text-xs opacity-70">
                ローカル保存のみ。CSVで外部共有できます。
              </div>
            </footer>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<GolfShotLogger />);
  </script>
</body>
</html>
